<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube タイムスタンプメーカー</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
  <style>
    :root{
      --bg:#0f172a;/* slate-900 */
      --panel:#111827;/* gray-900 */
      --muted:#334155;/* slate-600 */
      --text:#e5e7eb;/* gray-200 */
      --accent:#22d3ee;/* cyan-400 */
      --accent-2:#a78bfa;/* violet-400 */
      --danger:#f87171;/* red-400 */
      --ok:#4ade80;/* green-400 */
    }

    *{
      box-sizing:border-box
    }

    html, body{
      height:100%
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"
    }

    header{
      padding:16px 20px;
      border-bottom:1px solid #1f2937;
      background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0));
      position:sticky;
      top:0;
      z-index:10
    }

    header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.02em
    }

    main{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:16px;
      padding:16px;
      max-width:1300px;
      margin:0 auto
    }

    @media (max-width: 980px){
      main{
        grid-template-columns:1fr
      }
    }

    .card{
      background:var(--panel);
      border:1px solid #1f2937;
      border-radius:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.25)
    }

    .card h2{
      margin:0 0 8px 0;
      font-size:16px
    }

    .card
    .inner{
      padding:14px
    }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap
    }

    input[type="text"], input[type="number"], textarea, select{
      background:#0b1220;
      border:1px solid #223047;
      color:var(--text);padding:10px 12px;
      border-radius:10px;
      outline:none;
      width:100%;
    }

    textarea{
      min-height:140px;
      resize:vertical
    }

    button{
      background:#0b1220;
      border:1px solid #223047;
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border-color;
      display:inline-flex;
      align-items:center;
      gap:8px
    }

    button:hover{
      border-color:#2f415f
    }

    button.accent{
      border-color:var(--accent);
    }

    button.ok{
      border-color:var(--ok)
    }

    button.danger{
      border-color:var(--danger)
    }

    .hint{
      color:#93a3b8;
      font-size:12px
    }

    .kbd{
      background:#0b1220;
      border:1px solid #223047;
      padding:2px 6px;
      border-radius:6px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px
    }

    .item{
      display:grid;
      grid-template-columns: 92px 1fr auto;
      gap:8px;
      align-items:center;
      padding:8px;
      background:#0b1220;
      border:1px solid #223047;
      border-radius:10px
    }

    .time{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:14px;background:#07101e;border:1px solid #1a2740;
      border-radius:8px;
      padding:8px;
      text-align:center
    }

    .item-actions{
      display:flex;
      gap:6px
    }

    .muted{
      color:#9aa8be
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border:1px dashed #2a3b58;
      border-radius:999px;
      padding:6px 10px
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px
    }

    @media (max-width:720px){
      .grid2{
        grid-template-columns:1fr
      }
    }

    .small{
      font-size:12px
    }

    .spacer{
      height:8px
    }

    footer{
      padding:16px;
      text-align:center;
      color:#8092ad
    }

    .badge{
      font-size:11px;
      border:1px solid #2a3b58;
      border-radius:999px;
      padding:2px 8px
    }
  </style>
</head>
<body>
  <header>
    <h1>⏱️ タイムスタンプメーカー<span class="badge"><i class="fab fa-youtube"></i></span></h1>
  </header>
  <main>
    <section class="card" aria-label="プレイヤー">
      <div class="inner">
        <h2>🎬 動画を読み込み</h2>
        <div class="row">
          <input id="videoInput" type="text" placeholder="YouTube のURL または動画ID を貼り付け" />
          <button id="loadBtn" class="accent" title="動画を読み込み">読み込み</button>
        </div>
        <div class="hint" style="margin-top:6px">例）https://www.youtube.com/watch?v=<i>VIDEO_ID</i> / https://youtu.be/<i>VIDEO_ID</i> / https://www.youtube.com/live/<i>VIDEO_ID</i></div>

        <!-- 埋め込みプレイヤー領域 -->
        <div id="playerWrap">
          <div id="player" style="margin-top:12px;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden"></div>
        </div>

        <div class="spacer"></div>
        <label class="pill"><input type="checkbox" id="externalMode" style="margin-right:8px"> 埋め込み不可モード（外部プレイヤーで再生）</label>

        <!-- 外部プレイヤー用コントロール -->
        <div id="externalControls" style="display:none;margin-top:10px">
          <div class="row" style="align-items:center">
            <div id="extTimeDisplay" class="time">0:00</div>
            <button id="extStartStop">▶ 開始</button>
            <button id="extBack1">⏪ −1s</button>
            <button id="extFwd1">⏩ +1s</button>
            <button id="extBack5">⏪ −5s</button>
            <button id="extFwd5">⏩ +5s</button>
            <button id="markBtnExt" class="ok">📌 現在時刻を追加 (M)</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="extTimeInput" type="text" placeholder="h:mm:ss または mm:ss を入力して同期" style="max-width:200px" />
            <button id="extSync">この時刻に同期</button>
            <input id="ytTimeUrl" type="text" placeholder="YouTubeの『現在の再生位置のURL』（t=付き）を貼る" />
            <button id="extSyncFromUrl">URLから同期</button>
          </div>
          <div class="hint" style="margin-top:6px">YouTube で右クリック → 「<b>現在の再生位置の動画URLをコピー</b>」を貼ると <span class="kbd">t=</span> の秒数で同期できます。</div>
        </div>

        <div class="spacer"></div>
        <div class="row">
          <button id="playPauseBtn" title="スペースで再生/一時停止"><span>▶ / ⏸</span></button>
          <button id="back5">⏪ 5秒戻る</button>
          <button id="back1">⏪ 1秒戻る</button>
          <button id="fwd1">⏩ 1秒進む</button>
          <button id="fwd5">⏩ 5秒進む</button>
          <button id="markBtn" class="ok" title="M で現在時刻を追加">📌 現在時刻を追加 (M)</button>
          <input id="quickLabel" type="text" placeholder="ラベル（例：OP / ボス戦 / ガチャ）" style="max-width:280px" />
        </div>
        <div class="hint" style="margin-top:6px">ショートカット：<span class="kbd">Space</span> 再生/停止（外部モード時はストップウォッチ）・<span class="kbd">M</span> 追加・<span class="kbd">[</span>/<span class="kbd">]</span> 最後の項目を−/+1秒・<span class="kbd">Del</span> 最後を削除</div>
      </div>
    </section>

    <section class="card" aria-label="リスト">
      <div class="inner">
        <h2>📝 タイムスタンプ</h2>
        <div class="grid2">
          <label class="pill">オフセット (秒)
            <input id="offsetInput" type="number" step="1" value="0" style="max-width:120px;margin-left:8px" />
          </label>
          <label class="pill">丸め（秒）
            <select id="roundSelect" style="max-width:160px;margin-left:8px">
              <option value="0">丸めなし</option>
              <option value="1">1 秒</option>
              <option value="5">5 秒</option>
              <option value="10">10 秒</option>
            </select>
          </label>
        </div>
        <div class="hint" style="margin:6px 0 12px">※ オフセットは切り抜きや公開後のトリムで時刻がズレたときに便利です（+なら遅らせる）。</div>
        <div id="list" class="list" aria-live="polite"></div>
        <div class="row" style="margin-top:10px">
          <button id="clearBtn" class="danger">🗑 すべて削除</button>
          <button id="sortBtn">↕ 時刻順に並べ替え</button>
          <button id="ensureZeroBtn">0:00 を先頭に追加</button>
        </div>
        <div class="spacer"></div>
        <h2>📤 エクスポート</h2>
        <div class="row">
          <select id="exportFormat" style="max-width:240px">
            <option value="chapters">YouTube 章（0:00 見出し）</option>
            <option value="markdown">Markdown リスト</option>
            <option value="csv">CSV</option>
          </select>
          <button id="copyBtn" class="accent">📋 クリップボードにコピー</button>
          <button id="downloadBtn">💾 .txt を保存</button>
        </div>
        <textarea id="exportBox" placeholder="ここに出力されます（編集可能）" style="margin-top:10px"></textarea>
        <div class="spacer"></div>
        <h2>📥 インポート / 既存の修正</h2>
        <div class="row">
          <button id="importBtn">テキストから読み込み</button>
          <button id="sampleBtn">サンプル読み込み</button>
        </div>
        <div class="hint" style="margin-top:8px">行の形式例：<span class="kbd">1:23:45 ボス戦開始</span> / <span class="kbd">03:10 OP</span> / <span class="kbd">0:00 Opening</span></div>
      </div>
    </section>
  </main>

  <footer>Tips: YouTube では概要欄に <span class="kbd">0:00 見出し</span> 形式で貼ると自動でチャプターになります。</footer>

  <script>
    // ---- Helpers ----
    const $ = (sel)=>document.querySelector(sel);
    const listEl = $('#list');
    const exportBox = $('#exportBox');

    function pad(n){return String(Math.floor(Math.abs(n))).padStart(2,'0')}
    function formatTime(seconds){ seconds = Math.max(0, Math.floor(seconds)); const h = Math.floor(seconds/3600); const m = Math.floor((seconds%3600)/60); const s = seconds%60; return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`; }
    function parseTime(str){ const parts = str.trim().split(':').map(Number); if(parts.some(isNaN)) return null; if(parts.length===3){return parts[0]*3600 + parts[1]*60 + parts[2];} if(parts.length===2){return parts[0]*60 + parts[1];} if(parts.length===1){return parts[0];} return null; }

    function extractVideoId(input){
      input = input.trim();
      if(/^[a-zA-Z0-9_-]{11}$/.test(input)) return input; // plain ID
      try{
        const u = new URL(input);
        const host = u.hostname;
        const path = u.pathname.replace(/\/+$/,'');
        if(host.includes('youtu.be')){
          const seg = path.split('/').filter(Boolean);
          if(seg.length>=1 && /^[a-zA-Z0-9_-]{11}$/.test(seg[0])) return seg[0];
        }
        if(host.includes('youtube.com')){
          const v = u.searchParams.get('v');
          if(v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;
          const mLive = path.match(/\/live\/([a-zA-Z0-9_-]{11})/); if(mLive) return mLive[1];
          const mEmbed = path.match(/\/embed\/([a-zA-Z0-9_-]{11})/); if(mEmbed) return mEmbed[1];
          const mShorts = path.match(/\/shorts\/([a-zA-Z0-9_-]{11})/); if(mShorts) return mShorts[1];
        }
      }catch(e){ }
      return null;
    }

    // ---- State ----
    let player=null; let playerReady=false; let videoId=null;
    let items=[]; // {t:number,label:string}

    // External stopwatch state
    let extTimer=null, extRunning=false, extTimeSeconds=0, lastTick=0;
    function extTick(ts){ if(!extRunning){ lastTick=ts; return; } const dt=(ts-lastTick)/1000; lastTick=ts; extTimeSeconds += dt; updateExtDisplay(); extTimer=requestAnimationFrame(extTick); }
    function updateExtDisplay(){ $('#extTimeDisplay').textContent = formatTime(Math.floor(extTimeSeconds)); }
    function setExtTime(sec){ extTimeSeconds = Math.max(0, Math.floor(sec)); updateExtDisplay(); }

    function applyOffsetAndRound(sec){ const off = Number($('#offsetInput').value||0); const round = Number($('#roundSelect').value||0); let v = sec + off; if(round>0){v = Math.round(v/round)*round} return Math.max(0, v); }

    function getNowTime(){
      if($('#externalMode').checked){ return extTimeSeconds; }
      return playerReady? player.getCurrentTime() : 0;
    }

    function render(){
      listEl.innerHTML='';
      items.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className='item';
        const tDisplay = formatTime(applyOffsetAndRound(it.t));
        row.innerHTML = `
          <div class="time" title="クリックでシーク" data-idx="${idx}">${tDisplay}</div>
          <input class="label" type="text" value="${it.label.replace(/&/g,'&amp;').replace(/"/g,'&quot;')}" />
          <div class="item-actions">
            <button title="-1s" data-delta="-1">−1s</button>
            <button title="+1s" data-delta="1">+1s</button>
            <button title="-5s" data-delta="-5">−5s</button>
            <button title="+5s" data-delta="5">+5s</button>
            <button class="danger" title="削除" data-del="1">削除</button>
          </div>`;
        listEl.appendChild(row);
        row.querySelector('.label').addEventListener('input', (e)=>{ items[idx].label = e.target.value; updateExportPreview(); });
        row.querySelectorAll('button[data-delta]').forEach(btn=>btn.addEventListener('click',()=>{ const d = Number(btn.getAttribute('data-delta')); items[idx].t = Math.max(0, items[idx].t + d); render(); updateExportPreview(); }));
        row.querySelector('button[data-del]').addEventListener('click',()=>{ items.splice(idx,1); render(); updateExportPreview(); });
        row.querySelector('.time').addEventListener('click',()=>{ if(!$('#externalMode').checked && playerReady){ player.seekTo(applyOffsetAndRound(items[idx].t), true); player.playVideo(); }});
      });
      if(items.length===0){ const empty=document.createElement('div'); empty.className='muted'; empty.textContent='まだ項目がありません。動画を再生して「現在時刻を追加」を押すか、下のインポートから読み込んでください。'; listEl.appendChild(empty); }
    }

    function addItemFromPlayer(){ const t = getNowTime() || 0; const quick = $('#quickLabel').value.trim(); items.push({t: Math.floor(t), label: quick || ''}); render(); updateExportPreview(); $('#quickLabel').focus(); $('#quickLabel').select(); }
    function sortByTime(){ items.sort((a,b)=>a.t-b.t); render(); updateExportPreview(); }
    function ensureZero(){ const hasZero = items.some(it=>applyOffsetAndRound(it.t)===0); if(!hasZero){ items.unshift({t: -Number($('#offsetInput').value||0), label: 'OP'}); sortByTime(); } }

    function toExport(format){ const lines = items.slice().sort((a,b)=>applyOffsetAndRound(a.t)-applyOffsetAndRound(b.t)).map(it=>`${formatTime(applyOffsetAndRound(it.t))} ${it.label}`.trim()); if(format==='chapters') return lines.join('\n'); if(format==='markdown') return lines.map(l=>`- ${l}`).join('\n'); if(format==='csv') return ['time,label', ...lines.map(l=>{ const sp=l.indexOf(' '); if(sp<0) return `"${l}",""`; return `"${l.slice(0,sp)}","${l.slice(sp+1).replace(/"/g,'""')}"`; })].join('\n'); return lines.join('\n'); }
    function updateExportPreview(){ exportBox.value = toExport($('#exportFormat').value); }

    // ---- Export / Import ----
    $('#exportFormat').addEventListener('change', updateExportPreview);
    $('#copyBtn').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(exportBox.value); }catch(e){ alert('コピーに失敗：ブラウザの許可設定を確認してください'); } });
    $('#downloadBtn').addEventListener('click', ()=>{ const blob = new Blob([exportBox.value], {type:'text/plain;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `timestamps-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); });
    $('#importBtn').addEventListener('click', ()=>{ const txt = prompt('テキストを貼り付けてください（各行：時刻 ラベル）'); if(!txt) return; const rows = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); const parsed=[]; for(const line of rows){ const m = line.match(/^(\d{1,2}:(?:\d{2}:)?\d{2})\s*(.*)$/); if(m){ const t = parseTime(m[1]); parsed.push({t, label:m[2]||''}); } } if(parsed.length){ items = parsed; sortByTime(); updateExportPreview(); } else alert('解析できる行が見つかりませんでした。例: 1:23:45 ボス戦'); });
    $('#sampleBtn').addEventListener('click', ()=>{ items = [ {t:0, label:'OP'}, {t:190, label:'ステージ1 開始'}, {t:845, label:'ボス戦（初見）'}, {t:1325, label:'神回クリップ'} ]; render(); updateExportPreview(); });

    // ---- Player controls (embed mode) ----
    $('#playPauseBtn').addEventListener('click', ()=>{ if(!playerReady) return; const s=player.getPlayerState(); (s===1)?player.pauseVideo():player.playVideo(); });
    $('#back1').addEventListener('click', ()=>{ if(!playerReady) return; player.seekTo(Math.max(0, player.getCurrentTime()-1), true); });
    $('#fwd1').addEventListener('click', ()=>{ if(!playerReady) return; player.seekTo(player.getCurrentTime()+1, true); });
    $('#back5').addEventListener('click', ()=>{ if(!playerReady) return; player.seekTo(Math.max(0, player.getCurrentTime()-5), true); });
    $('#fwd5').addEventListener('click', ()=>{ if(!playerReady) return; player.seekTo(player.getCurrentTime()+5, true); });
    $('#markBtn').addEventListener('click', addItemFromPlayer);
    $('#sortBtn').addEventListener('click', sortByTime);
    $('#ensureZeroBtn').addEventListener('click', ()=>{ ensureZero(); updateExportPreview();});
    $('#clearBtn').addEventListener('click', ()=>{ if(confirm('すべて削除しますか？')){ items=[]; render(); updateExportPreview(); }});
    $('#offsetInput').addEventListener('input', ()=>{ render(); updateExportPreview(); });
    $('#roundSelect').addEventListener('change', ()=>{ render(); updateExportPreview(); });

    // ---- External controls ----
    $('#extStartStop').addEventListener('click', ()=>{ if(extRunning){ extRunning=false; $('#extStartStop').textContent='▶ 開始'; } else { extRunning=true; $('#extStartStop').textContent='⏸ 一時停止'; lastTick=performance.now(); extTimer=requestAnimationFrame(extTick); } });
    $('#extBack1').addEventListener('click', ()=> setExtTime(extTimeSeconds-1));
    $('#extFwd1').addEventListener('click', ()=> setExtTime(extTimeSeconds+1));
    $('#extBack5').addEventListener('click', ()=> setExtTime(extTimeSeconds-5));
    $('#extFwd5').addEventListener('click', ()=> setExtTime(extTimeSeconds+5));
    $('#extSync').addEventListener('click', ()=>{ const v=parseTime($('#extTimeInput').value); if(v!=null) setExtTime(v); });
    function parseTfromUrl(u){ try{ const url=new URL(u); let t=url.searchParams.get('t'); if(!t && url.hash) t=new URLSearchParams(url.hash.slice(1)).get('t'); if(!t) return null; if(/\d+s$/.test(t)) return parseInt(t); if(/^\d+$/.test(t)) return parseInt(t); return null; }catch(e){ return null; } }
    $('#extSyncFromUrl').addEventListener('click', ()=>{ const u=$('#ytTimeUrl').value.trim(); const s=parseTfromUrl(u); if(s!=null) setExtTime(s); else alert('t= の秒数が見つかりませんでした'); });

    // ---- Mode toggle ----
    $('#externalMode').addEventListener('change', ()=>{ const on = $('#externalMode').checked; $('#playerWrap').style.display = on ? 'none' : ''; $('#externalControls').style.display = on ? '' : 'none'; });

    // ---- Keyboard Shortcuts ----
    document.addEventListener('keydown', (e)=>{
      if(e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)){
        if(e.target.id==='quickLabel' && e.key==='Enter'){ e.preventDefault(); addItemFromPlayer(); }
        return;
      }
      if(e.key===' '){ e.preventDefault(); $('#externalMode').checked ? $('#extStartStop').click() : $('#playPauseBtn').click(); }
      if(e.key==='m' || e.key==='M'){ e.preventDefault(); addItemFromPlayer(); }
      if(e.key==='['){ e.preventDefault(); if(items.length){ items[items.length-1].t = Math.max(0, items[items.length-1].t-1); render(); updateExportPreview();}}
      if(e.key===']'){ e.preventDefault(); if(items.length){ items[items.length-1].t = items[items.length-1].t+1; render(); updateExportPreview();}}
      if(e.key==='Delete' || e.key==='Backspace'){ if(items.length && confirm('最後の項目を削除しますか？')){ items.pop(); render(); updateExportPreview(); }}
    });

    // ---- Load YouTube Iframe API ----
    function loadPlayer(id){
      return new Promise((resolve)=>{ if(window.YT && window.YT.Player){ resolve(); return; } const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.head.appendChild(tag); window.onYouTubeIframeAPIReady = ()=> resolve(); }).then(()=>{ if(player) { try{ player.destroy(); }catch(_){} } player = new YT.Player('player',{ height:'360', width:'640', videoId:id, playerVars:{autoplay:0, rel:0, modestbranding:1}, events:{ 'onReady': ()=>{ playerReady=true; }, 'onStateChange': ()=>{} } }); });
    }

    $('#loadBtn').addEventListener('click', async ()=>{ const input = $('#videoInput').value; const id = extractVideoId(input); if(!id){ alert('URL もしくは動画ID を正しく入力してください'); return; } videoId = id; playerReady=false; await loadPlayer(videoId); $('#quickLabel').focus(); });
    $('#videoInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#loadBtn').click(); }});

    // Initial render
    render(); updateExportPreview();
  </script>
</body>
</html>
